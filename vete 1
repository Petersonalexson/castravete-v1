Option Explicit

'==========================================================
' MAIN: Refresh Smart View and create arrays
'==========================================================
Public Sub RefreshSmartViewAndCreateArrays()
    RefreshSmartViewTree
    CreateHierarchyArrays
End Sub

'==========================================================
' REFRESH SMART VIEW HIERARCHIES
'==========================================================
Public Sub RefreshSmartViewTree()
    Dim arrSheets As Variant
    Dim ws As Worksheet
    Dim wsLists As Worksheet
    Dim ConnectionName As String
    Dim Ret As Long, HeaderRow As Long, LastRow As Long, I As Long
    Dim ConnStatus As Integer
    
    Set wsLists = ThisWorkbook.Worksheets("Lists")
    
    With wsLists
        ConnectionName = .Range("nmConnectionName").Value
        arrSheets = .Range("Hierarchy_Matrix").Value
    End With
    
    HeaderRow = 4
    
    For I = LBound(arrSheets) To UBound(arrSheets)
        Set ws = ThisWorkbook.Worksheets(arrSheets(I, 1))
        With ws
            Ret = HypUIConnect(.Name, "", "", ConnectionName)
            ConnStatus = HypConnected(.Name)
            If ConnStatus <> -1 Then Stop
            'Calculate last row
            LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
            'Delete hierarchy rows except hierarchy name
            If LastRow > HeaderRow Then
                .Rows(HeaderRow & ":" & LastRow - 1).Delete Shift:=xlUp
            End If
            LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
            Ret = HypSetSheetOption(.Name, HYP_SVC_OPTIONS_INDEX.HSV_MEMBER_DISPLAY, 1)
            Ret = HypZoomIn(.Name, .Range("A" & LastRow), 1, False)
            LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
            
            ' Delete the named range if it exists
            On Error Resume Next
            ThisWorkbook.Names(arrSheets(I, 2)).Delete
            On Error GoTo 0
            
            ThisWorkbook.Names.Add Name:=arrSheets(I, 2), RefersTo:=.Range("A" & HeaderRow & ":A" & LastRow)
        End With
    Next I
End Sub

'==========================================================
' CREATE HIERARCHY ARRAYS
' Creates arrays from row 3 to last row
'==========================================================
Public Sub CreateHierarchyArrays()
    Dim wsLists As Worksheet
    Dim arrSheets As Variant
    Dim i As Long
    Dim rangeName As String
    Dim hierarchyName As String
    Dim arrCount As Long
    
    Set wsLists = ThisWorkbook.Worksheets("Lists")
    arrSheets = wsLists.Range("Hierarchy_Matrix").Value
    arrCount = 0
    
    For i = LBound(arrSheets) To UBound(arrSheets)
        rangeName = Trim(arrSheets(i, 2))
        hierarchyName = Trim(arrSheets(i, 3))
        
        ' Skip if empty
        If rangeName = "" Then GoTo NextArray
        
        ' Create array starting from row 3
        Dim rng As Range
        Dim dataArray As Variant
        
        On Error Resume Next
        Set rng = ThisWorkbook.Names(rangeName).RefersToRange
        If rng Is Nothing Then GoTo NextArray
        On Error GoTo 0
        
        ' Process only if range has at least 3 rows
        If rng.Rows.Count >= 3 Then
            ' Create array from row 3 to last row
            Set dataArray = rng.Worksheet.Range(rng.Cells(3, 1), rng.Cells(rng.Rows.Count, 1)).Value
            arrCount = arrCount + 1
        End If
        
NextArray:
    Next i
    
    MsgBox "Created " & arrCount & " arrays", vbInformation
End Sub
