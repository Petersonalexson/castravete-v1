let
    // Step 1: Reference existing SmartViewData table
    SmartViewData = Excel.CurrentWorkbook(){[Name="SmartViewData"]}[Content],
    
    // Step 2: Extract only the necessary columns from SmartViewData
    SVCleaned = Table.SelectColumns(SmartViewData, {"Hierarchy Name", "Type", "Value", "Parent", "KEY"}),
    
    // Step 3: Reference Hierarchy Matrix to get the list of hierarchies to process
    HierarchyMatrix = Excel.CurrentWorkbook(){[Name="Hierarchy_Matrix"]}[Content],
    
    // Step 4: Ensure column names are correct in hierarchy matrix
    MatrixRenamed = Table.RenameColumns(HierarchyMatrix, {
        {"Column1", "Sheet Name"}, 
        {"Column2", "Range Name"}, 
        {"Column3", "Hierarchy Name"}, 
        {"Column4", "Type"}
    }),
    
    // Step 5: Import XRP Tree File
    SourceTree = Excel.Workbook(File.Contents("C:\Path\To\Your\XRPTreeFile.xlsx"), null, true),
    XRPTreeSheet = SourceTree{[Item="Sheet1",Kind="Sheet"]}[Data],
    XRPTreeHeaders = Table.PromoteHeaders(Table.Skip(XRPTreeSheet, 4), [PromoteAllScalars=true]),
    
    // Step 6: Import XRP List File
    SourceList = Excel.Workbook(File.Contents("C:\Path\To\Your\XRPListFile.xlsx"), null, true),
    XRPListSheet = SourceList{[Item="Sheet1",Kind="Sheet"]}[Data],
    XRPListHeaders = Table.PromoteHeaders(Table.Skip(XRPListSheet, 4), [PromoteAllScalars=true]),
    
    // Step 7: Clean and rename XRP Tree data
    XRPTreeCleaned = Table.SelectColumns(XRPTreeHeaders, {"Tree Name", "Value", "Parent"}),
    XRPTreeRenamed = Table.RenameColumns(XRPTreeCleaned, {
        {"Tree Name", "Hierarchy Name"},
        {"Value", "XRP_Value"},
        {"Parent", "XRP_Parent"}
    }),
    
    // Step 8: Add Type column to XRP Tree data
    XRPTreeWithType = Table.AddColumn(XRPTreeRenamed, "Type", each "Tree", type text),
    
    // Step 9: Clean and rename XRP List data
    XRPListCleaned = Table.SelectColumns(XRPListHeaders, {"Tree Name", "Value", "Parent"}),
    XRPListRenamed = Table.RenameColumns(XRPListCleaned, {
        {"Tree Name", "Hierarchy Name"},
        {"Value", "XRP_Value"},
        {"Parent", "XRP_Parent"}
    }),
    
    // Step 10: Add Type column to XRP List data
    XRPListWithType = Table.AddColumn(XRPListRenamed, "Type", each "List", type text),
    
    // Step 11: Combine both XRP data sources
    CombinedXRP = Table.Combine({XRPTreeWithType, XRPListWithType}),
    
    // Step 12: Create KEY column for XRP data (same structure as SmartViewData's KEY)
    XRPWithKey = Table.AddColumn(CombinedXRP, "KEY", each [Hierarchy Name] & " | " & [XRP_Value], type text),
    
    // Step 13: Filter SmartViewData based on hierarchies in the Matrix (optional, can be removed if all should be processed)
    SVWithHierarchies = Table.NestedJoin(
        SVCleaned,
        {"Hierarchy Name", "Type"},
        MatrixRenamed,
        {"Hierarchy Name", "Type"},
        "HierarchyMatches",
        JoinKind.Inner
    ),
    SVFiltered = Table.RemoveColumns(SVWithHierarchies, {"HierarchyMatches"}),
    
    // Step 14: Rename columns in SmartViewData for clarity
    SVRenamed = Table.RenameColumns(SVFiltered, {
        {"Value", "SV_Value"},
        {"Parent", "SV_Parent"}
    }),
    
    // Step 15: Perform full outer join between SmartView and XRP data
    // First, join SmartView to XRP (to find matches and items missing in XRP)
    SVtoXRPJoin = Table.NestedJoin(
        SVRenamed,
        {"KEY"},
        XRPWithKey,
        {"KEY"},
        "XRPMatches",
        JoinKind.LeftOuter
    ),
    ExpandedSVtoXRP = Table.ExpandTableColumn(
        SVtoXRPJoin,
        "XRPMatches",
        {"XRP_Parent"},
        {"XRP_Parent"}
    ),
    
    // Step 16: Find items in XRP not in SmartView
    XRPtoSVJoin = Table.NestedJoin(
        XRPWithKey,
        {"KEY"},
        SVRenamed,
        {"KEY"},
        "SVMatches",
        JoinKind.LeftAnti
    ),
    
    // Step 17: Add empty columns for SmartView data in the anti-join results
    XRPOnlyWithColumns = Table.AddColumn(XRPtoSVJoin, "SV_Value", each null, type text),
    XRPOnlyWithMoreColumns = Table.AddColumn(XRPOnlyWithColumns, "SV_Parent", each null, type text),
    
    // Step 18: Select and reorder columns for XRP-only data to match main table
    XRPOnlyReordered = Table.SelectColumns(XRPOnlyWithMoreColumns, {
        "Hierarchy Name", "Type", "SV_Value", "SV_Parent", "XRP_Value", "XRP_Parent", "KEY"
    }),
    
    // Step 19: Rename columns for proper display in combined result
    XRPOnlyRenamed = Table.RenameColumns(XRPOnlyReordered, {{"XRP_Value", "Value"}}),
    
    // Step 20: Combine both results
    AllResults = Table.Combine({ExpandedSVtoXRP, XRPOnlyRenamed}),
    
    // Step 21: Add Status column based on comparison
    WithStatus = Table.AddColumn(AllResults, "Status", each
        if [SV_Value] = null then "Missing in SmartView"
        else if [XRP_Parent] = null then "Missing in XRP"
        else if [SV_Parent] <> [XRP_Parent] then "Different Parent"
        else "Match",
        type text
    ),
    
    // Step 22: Extract the actual Value from the KEY for display purposes
    WithValueExtracted = Table.AddColumn(WithStatus, "Value", each
        if [SV_Value] <> null then [SV_Value] else Text.AfterDelimiter([KEY], " | ", 1),
        type text
    ),
    
    // Step 23: Reorder and select final columns for output
    FinalColumns = Table.SelectColumns(WithValueExtracted, {
        "Hierarchy Name", "Type", "Value", "SV_Parent", "XRP_Parent", "Status"
    }),
    
    // Step 24: Sort results by hierarchy, type, and status
    SortedResults = Table.Sort(FinalColumns, {
        {"Hierarchy Name", Order.Ascending},
        {"Type", Order.Ascending},
        {"Status", Order.Ascending}
    })
in
    SortedResults
